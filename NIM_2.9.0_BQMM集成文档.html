<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<style type="text/css">
.ef0,.f0 { color: #000000; } .eb0,.b0 { background-color: #000000; }
.ef1,.f1 { color: #AA0000; } .eb1,.b1 { background-color: #AA0000; }
.ef2,.f2 { color: #00AA00; } .eb2,.b2 { background-color: #00AA00; }
.ef3,.f3 { color: #AA5500; } .eb3,.b3 { background-color: #AA5500; }
.ef4,.f4 { color: #0000AA; } .eb4,.b4 { background-color: #0000AA; }
.ef5,.f5 { color: #AA00AA; } .eb5,.b5 { background-color: #AA00AA; }
.ef6,.f6 { color: #FF55FF; } .eb6,.b6 { background-color: #FF55FF; }
.ef7,.f7 { color: #AAAAAA; } .eb7,.b7 { background-color: #AAAAAA; }
.ef8, .f0 > .bold,.bold > .f0 { color: #555555; font-weight: normal; }
.ef9, .f1 > .bold,.bold > .f1 { color: #FF5555; font-weight: normal; }
.ef10,.f2 > .bold,.bold > .f2 { color: #55FF55; font-weight: normal; }
.ef11,.f3 > .bold,.bold > .f3 { color: #FFFF55; font-weight: normal; }
.ef12,.f4 > .bold,.bold > .f4 { color: #5555FF; font-weight: normal; }
.ef13,.f5 > .bold,.bold > .f5 { color: #FF55FF; font-weight: normal; }
.ef14,.f6 > .bold,.bold > .f6 { color: #55FFFF; font-weight: normal; }
.ef15,.f7 > .bold,.bold > .f7 { color: #FFFFFF; font-weight: normal; }
.eb8  { background-color: #555555; }
.eb9  { background-color: #FF5555; }
.eb10 { background-color: #55FF55; }
.eb11 { background-color: #FFFF55; }
.eb12 { background-color: #5555FF; }
.eb13 { background-color: #FF55FF; }
.eb14 { background-color: #55FFFF; }
.eb15 { background-color: #FFFFFF; }
.ef16 { color: #000000; } .eb16 { background-color: #000000; }
.ef17 { color: #00005f; } .eb17 { background-color: #00005f; }
.ef18 { color: #000087; } .eb18 { background-color: #000087; }
.ef19 { color: #0000af; } .eb19 { background-color: #0000af; }
.ef20 { color: #0000d7; } .eb20 { background-color: #0000d7; }
.ef21 { color: #0000ff; } .eb21 { background-color: #0000ff; }
.ef22 { color: #005f00; } .eb22 { background-color: #005f00; }
.ef23 { color: #005f5f; } .eb23 { background-color: #005f5f; }
.ef24 { color: #005f87; } .eb24 { background-color: #005f87; }
.ef25 { color: #005faf; } .eb25 { background-color: #005faf; }
.ef26 { color: #005fd7; } .eb26 { background-color: #005fd7; }
.ef27 { color: #005fff; } .eb27 { background-color: #005fff; }
.ef28 { color: #008700; } .eb28 { background-color: #008700; }
.ef29 { color: #00875f; } .eb29 { background-color: #00875f; }
.ef30 { color: #008787; } .eb30 { background-color: #008787; }
.ef31 { color: #0087af; } .eb31 { background-color: #0087af; }
.ef32 { color: #0087d7; } .eb32 { background-color: #0087d7; }
.ef33 { color: #0087ff; } .eb33 { background-color: #0087ff; }
.ef34 { color: #00af00; } .eb34 { background-color: #00af00; }
.ef35 { color: #00af5f; } .eb35 { background-color: #00af5f; }
.ef36 { color: #00af87; } .eb36 { background-color: #00af87; }
.ef37 { color: #00afaf; } .eb37 { background-color: #00afaf; }
.ef38 { color: #00afd7; } .eb38 { background-color: #00afd7; }
.ef39 { color: #00afff; } .eb39 { background-color: #00afff; }
.ef40 { color: #00d700; } .eb40 { background-color: #00d700; }
.ef41 { color: #00d75f; } .eb41 { background-color: #00d75f; }
.ef42 { color: #00d787; } .eb42 { background-color: #00d787; }
.ef43 { color: #00d7af; } .eb43 { background-color: #00d7af; }
.ef44 { color: #00d7d7; } .eb44 { background-color: #00d7d7; }
.ef45 { color: #00d7ff; } .eb45 { background-color: #00d7ff; }
.ef46 { color: #00ff00; } .eb46 { background-color: #00ff00; }
.ef47 { color: #00ff5f; } .eb47 { background-color: #00ff5f; }
.ef48 { color: #00ff87; } .eb48 { background-color: #00ff87; }
.ef49 { color: #00ffaf; } .eb49 { background-color: #00ffaf; }
.ef50 { color: #00ffd7; } .eb50 { background-color: #00ffd7; }
.ef51 { color: #00ffff; } .eb51 { background-color: #00ffff; }
.ef52 { color: #5f0000; } .eb52 { background-color: #5f0000; }
.ef53 { color: #5f005f; } .eb53 { background-color: #5f005f; }
.ef54 { color: #5f0087; } .eb54 { background-color: #5f0087; }
.ef55 { color: #5f00af; } .eb55 { background-color: #5f00af; }
.ef56 { color: #5f00d7; } .eb56 { background-color: #5f00d7; }
.ef57 { color: #5f00ff; } .eb57 { background-color: #5f00ff; }
.ef58 { color: #5f5f00; } .eb58 { background-color: #5f5f00; }
.ef59 { color: #5f5f5f; } .eb59 { background-color: #5f5f5f; }
.ef60 { color: #5f5f87; } .eb60 { background-color: #5f5f87; }
.ef61 { color: #5f5faf; } .eb61 { background-color: #5f5faf; }
.ef62 { color: #5f5fd7; } .eb62 { background-color: #5f5fd7; }
.ef63 { color: #5f5fff; } .eb63 { background-color: #5f5fff; }
.ef64 { color: #5f8700; } .eb64 { background-color: #5f8700; }
.ef65 { color: #5f875f; } .eb65 { background-color: #5f875f; }
.ef66 { color: #5f8787; } .eb66 { background-color: #5f8787; }
.ef67 { color: #5f87af; } .eb67 { background-color: #5f87af; }
.ef68 { color: #5f87d7; } .eb68 { background-color: #5f87d7; }
.ef69 { color: #5f87ff; } .eb69 { background-color: #5f87ff; }
.ef70 { color: #5faf00; } .eb70 { background-color: #5faf00; }
.ef71 { color: #5faf5f; } .eb71 { background-color: #5faf5f; }
.ef72 { color: #5faf87; } .eb72 { background-color: #5faf87; }
.ef73 { color: #5fafaf; } .eb73 { background-color: #5fafaf; }
.ef74 { color: #5fafd7; } .eb74 { background-color: #5fafd7; }
.ef75 { color: #5fafff; } .eb75 { background-color: #5fafff; }
.ef76 { color: #5fd700; } .eb76 { background-color: #5fd700; }
.ef77 { color: #5fd75f; } .eb77 { background-color: #5fd75f; }
.ef78 { color: #5fd787; } .eb78 { background-color: #5fd787; }
.ef79 { color: #5fd7af; } .eb79 { background-color: #5fd7af; }
.ef80 { color: #5fd7d7; } .eb80 { background-color: #5fd7d7; }
.ef81 { color: #5fd7ff; } .eb81 { background-color: #5fd7ff; }
.ef82 { color: #5fff00; } .eb82 { background-color: #5fff00; }
.ef83 { color: #5fff5f; } .eb83 { background-color: #5fff5f; }
.ef84 { color: #5fff87; } .eb84 { background-color: #5fff87; }
.ef85 { color: #5fffaf; } .eb85 { background-color: #5fffaf; }
.ef86 { color: #5fffd7; } .eb86 { background-color: #5fffd7; }
.ef87 { color: #5fffff; } .eb87 { background-color: #5fffff; }
.ef88 { color: #870000; } .eb88 { background-color: #870000; }
.ef89 { color: #87005f; } .eb89 { background-color: #87005f; }
.ef90 { color: #870087; } .eb90 { background-color: #870087; }
.ef91 { color: #8700af; } .eb91 { background-color: #8700af; }
.ef92 { color: #8700d7; } .eb92 { background-color: #8700d7; }
.ef93 { color: #8700ff; } .eb93 { background-color: #8700ff; }
.ef94 { color: #875f00; } .eb94 { background-color: #875f00; }
.ef95 { color: #875f5f; } .eb95 { background-color: #875f5f; }
.ef96 { color: #875f87; } .eb96 { background-color: #875f87; }
.ef97 { color: #875faf; } .eb97 { background-color: #875faf; }
.ef98 { color: #875fd7; } .eb98 { background-color: #875fd7; }
.ef99 { color: #875fff; } .eb99 { background-color: #875fff; }
.ef100 { color: #878700; } .eb100 { background-color: #878700; }
.ef101 { color: #87875f; } .eb101 { background-color: #87875f; }
.ef102 { color: #878787; } .eb102 { background-color: #878787; }
.ef103 { color: #8787af; } .eb103 { background-color: #8787af; }
.ef104 { color: #8787d7; } .eb104 { background-color: #8787d7; }
.ef105 { color: #8787ff; } .eb105 { background-color: #8787ff; }
.ef106 { color: #87af00; } .eb106 { background-color: #87af00; }
.ef107 { color: #87af5f; } .eb107 { background-color: #87af5f; }
.ef108 { color: #87af87; } .eb108 { background-color: #87af87; }
.ef109 { color: #87afaf; } .eb109 { background-color: #87afaf; }
.ef110 { color: #87afd7; } .eb110 { background-color: #87afd7; }
.ef111 { color: #87afff; } .eb111 { background-color: #87afff; }
.ef112 { color: #87d700; } .eb112 { background-color: #87d700; }
.ef113 { color: #87d75f; } .eb113 { background-color: #87d75f; }
.ef114 { color: #87d787; } .eb114 { background-color: #87d787; }
.ef115 { color: #87d7af; } .eb115 { background-color: #87d7af; }
.ef116 { color: #87d7d7; } .eb116 { background-color: #87d7d7; }
.ef117 { color: #87d7ff; } .eb117 { background-color: #87d7ff; }
.ef118 { color: #87ff00; } .eb118 { background-color: #87ff00; }
.ef119 { color: #87ff5f; } .eb119 { background-color: #87ff5f; }
.ef120 { color: #87ff87; } .eb120 { background-color: #87ff87; }
.ef121 { color: #87ffaf; } .eb121 { background-color: #87ffaf; }
.ef122 { color: #87ffd7; } .eb122 { background-color: #87ffd7; }
.ef123 { color: #87ffff; } .eb123 { background-color: #87ffff; }
.ef124 { color: #af0000; } .eb124 { background-color: #af0000; }
.ef125 { color: #af005f; } .eb125 { background-color: #af005f; }
.ef126 { color: #af0087; } .eb126 { background-color: #af0087; }
.ef127 { color: #af00af; } .eb127 { background-color: #af00af; }
.ef128 { color: #af00d7; } .eb128 { background-color: #af00d7; }
.ef129 { color: #af00ff; } .eb129 { background-color: #af00ff; }
.ef130 { color: #af5f00; } .eb130 { background-color: #af5f00; }
.ef131 { color: #af5f5f; } .eb131 { background-color: #af5f5f; }
.ef132 { color: #af5f87; } .eb132 { background-color: #af5f87; }
.ef133 { color: #af5faf; } .eb133 { background-color: #af5faf; }
.ef134 { color: #af5fd7; } .eb134 { background-color: #af5fd7; }
.ef135 { color: #af5fff; } .eb135 { background-color: #af5fff; }
.ef136 { color: #af8700; } .eb136 { background-color: #af8700; }
.ef137 { color: #af875f; } .eb137 { background-color: #af875f; }
.ef138 { color: #af8787; } .eb138 { background-color: #af8787; }
.ef139 { color: #af87af; } .eb139 { background-color: #af87af; }
.ef140 { color: #af87d7; } .eb140 { background-color: #af87d7; }
.ef141 { color: #af87ff; } .eb141 { background-color: #af87ff; }
.ef142 { color: #afaf00; } .eb142 { background-color: #afaf00; }
.ef143 { color: #afaf5f; } .eb143 { background-color: #afaf5f; }
.ef144 { color: #afaf87; } .eb144 { background-color: #afaf87; }
.ef145 { color: #afafaf; } .eb145 { background-color: #afafaf; }
.ef146 { color: #afafd7; } .eb146 { background-color: #afafd7; }
.ef147 { color: #afafff; } .eb147 { background-color: #afafff; }
.ef148 { color: #afd700; } .eb148 { background-color: #afd700; }
.ef149 { color: #afd75f; } .eb149 { background-color: #afd75f; }
.ef150 { color: #afd787; } .eb150 { background-color: #afd787; }
.ef151 { color: #afd7af; } .eb151 { background-color: #afd7af; }
.ef152 { color: #afd7d7; } .eb152 { background-color: #afd7d7; }
.ef153 { color: #afd7ff; } .eb153 { background-color: #afd7ff; }
.ef154 { color: #afff00; } .eb154 { background-color: #afff00; }
.ef155 { color: #afff5f; } .eb155 { background-color: #afff5f; }
.ef156 { color: #afff87; } .eb156 { background-color: #afff87; }
.ef157 { color: #afffaf; } .eb157 { background-color: #afffaf; }
.ef158 { color: #afffd7; } .eb158 { background-color: #afffd7; }
.ef159 { color: #afffff; } .eb159 { background-color: #afffff; }
.ef160 { color: #d70000; } .eb160 { background-color: #d70000; }
.ef161 { color: #d7005f; } .eb161 { background-color: #d7005f; }
.ef162 { color: #d70087; } .eb162 { background-color: #d70087; }
.ef163 { color: #d700af; } .eb163 { background-color: #d700af; }
.ef164 { color: #d700d7; } .eb164 { background-color: #d700d7; }
.ef165 { color: #d700ff; } .eb165 { background-color: #d700ff; }
.ef166 { color: #d75f00; } .eb166 { background-color: #d75f00; }
.ef167 { color: #d75f5f; } .eb167 { background-color: #d75f5f; }
.ef168 { color: #d75f87; } .eb168 { background-color: #d75f87; }
.ef169 { color: #d75faf; } .eb169 { background-color: #d75faf; }
.ef170 { color: #d75fd7; } .eb170 { background-color: #d75fd7; }
.ef171 { color: #d75fff; } .eb171 { background-color: #d75fff; }
.ef172 { color: #d78700; } .eb172 { background-color: #d78700; }
.ef173 { color: #d7875f; } .eb173 { background-color: #d7875f; }
.ef174 { color: #d78787; } .eb174 { background-color: #d78787; }
.ef175 { color: #d787af; } .eb175 { background-color: #d787af; }
.ef176 { color: #d787d7; } .eb176 { background-color: #d787d7; }
.ef177 { color: #d787ff; } .eb177 { background-color: #d787ff; }
.ef178 { color: #d7af00; } .eb178 { background-color: #d7af00; }
.ef179 { color: #d7af5f; } .eb179 { background-color: #d7af5f; }
.ef180 { color: #d7af87; } .eb180 { background-color: #d7af87; }
.ef181 { color: #d7afaf; } .eb181 { background-color: #d7afaf; }
.ef182 { color: #d7afd7; } .eb182 { background-color: #d7afd7; }
.ef183 { color: #d7afff; } .eb183 { background-color: #d7afff; }
.ef184 { color: #d7d700; } .eb184 { background-color: #d7d700; }
.ef185 { color: #d7d75f; } .eb185 { background-color: #d7d75f; }
.ef186 { color: #d7d787; } .eb186 { background-color: #d7d787; }
.ef187 { color: #d7d7af; } .eb187 { background-color: #d7d7af; }
.ef188 { color: #d7d7d7; } .eb188 { background-color: #d7d7d7; }
.ef189 { color: #d7d7ff; } .eb189 { background-color: #d7d7ff; }
.ef190 { color: #d7ff00; } .eb190 { background-color: #d7ff00; }
.ef191 { color: #d7ff5f; } .eb191 { background-color: #d7ff5f; }
.ef192 { color: #d7ff87; } .eb192 { background-color: #d7ff87; }
.ef193 { color: #d7ffaf; } .eb193 { background-color: #d7ffaf; }
.ef194 { color: #d7ffd7; } .eb194 { background-color: #d7ffd7; }
.ef195 { color: #d7ffff; } .eb195 { background-color: #d7ffff; }
.ef196 { color: #ff0000; } .eb196 { background-color: #ff0000; }
.ef197 { color: #ff005f; } .eb197 { background-color: #ff005f; }
.ef198 { color: #ff0087; } .eb198 { background-color: #ff0087; }
.ef199 { color: #ff00af; } .eb199 { background-color: #ff00af; }
.ef200 { color: #ff00d7; } .eb200 { background-color: #ff00d7; }
.ef201 { color: #ff00ff; } .eb201 { background-color: #ff00ff; }
.ef202 { color: #ff5f00; } .eb202 { background-color: #ff5f00; }
.ef203 { color: #ff5f5f; } .eb203 { background-color: #ff5f5f; }
.ef204 { color: #ff5f87; } .eb204 { background-color: #ff5f87; }
.ef205 { color: #ff5faf; } .eb205 { background-color: #ff5faf; }
.ef206 { color: #ff5fd7; } .eb206 { background-color: #ff5fd7; }
.ef207 { color: #ff5fff; } .eb207 { background-color: #ff5fff; }
.ef208 { color: #ff8700; } .eb208 { background-color: #ff8700; }
.ef209 { color: #ff875f; } .eb209 { background-color: #ff875f; }
.ef210 { color: #ff8787; } .eb210 { background-color: #ff8787; }
.ef211 { color: #ff87af; } .eb211 { background-color: #ff87af; }
.ef212 { color: #ff87d7; } .eb212 { background-color: #ff87d7; }
.ef213 { color: #ff87ff; } .eb213 { background-color: #ff87ff; }
.ef214 { color: #ffaf00; } .eb214 { background-color: #ffaf00; }
.ef215 { color: #ffaf5f; } .eb215 { background-color: #ffaf5f; }
.ef216 { color: #ffaf87; } .eb216 { background-color: #ffaf87; }
.ef217 { color: #ffafaf; } .eb217 { background-color: #ffafaf; }
.ef218 { color: #ffafd7; } .eb218 { background-color: #ffafd7; }
.ef219 { color: #ffafff; } .eb219 { background-color: #ffafff; }
.ef220 { color: #ffd700; } .eb220 { background-color: #ffd700; }
.ef221 { color: #ffd75f; } .eb221 { background-color: #ffd75f; }
.ef222 { color: #ffd787; } .eb222 { background-color: #ffd787; }
.ef223 { color: #ffd7af; } .eb223 { background-color: #ffd7af; }
.ef224 { color: #ffd7d7; } .eb224 { background-color: #ffd7d7; }
.ef225 { color: #ffd7ff; } .eb225 { background-color: #ffd7ff; }
.ef226 { color: #ffff00; } .eb226 { background-color: #ffff00; }
.ef227 { color: #ffff5f; } .eb227 { background-color: #ffff5f; }
.ef228 { color: #ffff87; } .eb228 { background-color: #ffff87; }
.ef229 { color: #ffffaf; } .eb229 { background-color: #ffffaf; }
.ef230 { color: #ffffd7; } .eb230 { background-color: #ffffd7; }
.ef231 { color: #ffffff; } .eb231 { background-color: #ffffff; }
.ef232 { color: #080808; } .eb232 { background-color: #080808; }
.ef233 { color: #121212; } .eb233 { background-color: #121212; }
.ef234 { color: #1c1c1c; } .eb234 { background-color: #1c1c1c; }
.ef235 { color: #262626; } .eb235 { background-color: #262626; }
.ef236 { color: #303030; } .eb236 { background-color: #303030; }
.ef237 { color: #3a3a3a; } .eb237 { background-color: #3a3a3a; }
.ef238 { color: #444444; } .eb238 { background-color: #444444; }
.ef239 { color: #4e4e4e; } .eb239 { background-color: #4e4e4e; }
.ef240 { color: #585858; } .eb240 { background-color: #585858; }
.ef241 { color: #626262; } .eb241 { background-color: #626262; }
.ef242 { color: #6c6c6c; } .eb242 { background-color: #6c6c6c; }
.ef243 { color: #767676; } .eb243 { background-color: #767676; }
.ef244 { color: #808080; } .eb244 { background-color: #808080; }
.ef245 { color: #8a8a8a; } .eb245 { background-color: #8a8a8a; }
.ef246 { color: #949494; } .eb246 { background-color: #949494; }
.ef247 { color: #9e9e9e; } .eb247 { background-color: #9e9e9e; }
.ef248 { color: #a8a8a8; } .eb248 { background-color: #a8a8a8; }
.ef249 { color: #b2b2b2; } .eb249 { background-color: #b2b2b2; }
.ef250 { color: #bcbcbc; } .eb250 { background-color: #bcbcbc; }
.ef251 { color: #c6c6c6; } .eb251 { background-color: #c6c6c6; }
.ef252 { color: #d0d0d0; } .eb252 { background-color: #d0d0d0; }
.ef253 { color: #dadada; } .eb253 { background-color: #dadada; }
.ef254 { color: #e4e4e4; } .eb254 { background-color: #e4e4e4; }
.ef255 { color: #eeeeee; } .eb255 { background-color: #eeeeee; }

.f9 { color: #000000; }
.b9 { background-color: #FFFFFF; }
.f9 > .bold,.bold > .f9, body.f9 > pre > .bold {
  /* Bold is heavy black on white, or bright white
     depending on the default background */
  color: #5555FF;
  font-weight: bold;
}
.reverse {
  /* CSS does not support swapping fg and bg colours unfortunately,
     so just hardcode something that will look OK on all backgrounds. */
  color: #000000; background-color: #AAAAAA;
}
.underline { text-decoration: underline; }
.line-through { text-decoration: line-through; }
.blink { text-decoration: blink; }

/* Avoid pixels between adjacent span elements.
   Note this only works for lines less than 80 chars
   where we close span elements on the same line.
span { display: inline-block; }
*/
</style>
</head>

<body class="f9 b9">
<h1>说明：</h1>
  <ul>
  	<li>
  		<p>
  			本Demo使用的是
  			<a href="http://netease.im/im-sdk-demo">版本号为v2.9.0网易云信官方Demo</a>
  		</p>
  	</li>
  	<li>
  		<p>
  			本Demo在网易云信官方Demo的基础上集成了BQMM,在修改的地方我们都加上了“BQMM集成"的注释，可在项目中全局搜索查看
  		</p>
  	</li>
  	<li>
  		<p>
  			我们提供了集成之后的Demo与官方Demo的Diff文档,供大家查看 (绿色为新增的代码，红色为删除的代码)
  		</p>
  	</li>
  </ul>


  <h1>
  	集成之后的Demo与官方Demo的Diff文档：
  </h1>
<pre>
<span class="bold">diff --git a/ NIM_iOS_Demo_v2.9.0/NIMDemo/NIMDemo/Classes/Common/Addons/UINavigationBar+Swizzling.m b/ NIM_iOS_Demo_v2.9.0/NIMDemo/NIMDemo/Classes/Common/Addons/UINavigationBar+Swizzling.m
index bb3d0f0..beb00a8 100644</span>
<span class="bold">--- a/ NIM_iOS_Demo_v2.9.0/NIMDemo/NIMDemo/Classes/Common/Addons/UINavigationBar+Swizzling.m</span>	
<span class="bold">+++ b/ NIM_iOS_Demo_v2.9.0/NIMDemo/NIMDemo/Classes/Common/Addons/UINavigationBar+Swizzling.m</span>	
<span class="f6">@@ -25,7 +25,10 @@</span> - (void)swizzling_layoutSubviews{
    [self swizzling_layoutSubviews];
    UINavigationItem *navigationItem = [self topItem];
    UIView *subview  = [[navigationItem leftBarButtonItem] customView];
    <span class="f2">//BQMM集成</span>
<span class="f2">    if (subview.tag == 1000) {</span>
        subview.left = NavigationBtnMargin;
    <span class="f2">}</span>
    
    //解决标题过长时，设置navigationItem.title导致标题偏移的问题
    UILabel *label = (UILabel *)navigationItem.titleView;
<span class="bold">diff --git a/ NIM_iOS_Demo_v2.9.0/NIMDemo/NIMDemo/Classes/Sections/Chatroom/Config/NTESChatroomTextContentConfig.m b/ NIM_iOS_Demo_v2.9.0/NIMDemo/NIMDemo/Classes/Sections/Chatroom/Config/NTESChatroomTextContentConfig.m
index 27568fe..0895146 100644</span>
<span class="bold">--- a/ NIM_iOS_Demo_v2.9.0/NIMDemo/NIMDemo/Classes/Sections/Chatroom/Config/NTESChatroomTextContentConfig.m</span>	
<span class="bold">+++ b/ NIM_iOS_Demo_v2.9.0/NIMDemo/NIMDemo/Classes/Sections/Chatroom/Config/NTESChatroomTextContentConfig.m</span>	
<span class="f6">@@ -10,9 +10,15 @@</span>
#import &quot;NIMAttributedLabel+NIMKit.h&quot;
#import &quot;NIMGlobalMacro.h&quot;

<span class="f2">//BQMM集成</span>
<span class="f2">#import &quot;MMTextParser.h&quot;</span>
<span class="f2">#import &quot;MMTextView.h&quot;</span>

@interface NTESChatroomTextContentConfig()

<span class="f2">//BQMM集成</span>
<span class="f2">//</span>@property (nonatomic, strong) NIMAttributedLabel *label;
<span class="f2">@property (nonatomic, strong) MMTextView *textMessageView;</span>

@end

<span class="f6">@@ -20,18 +26,41 @@</span> @implementation NTESChatroomTextContentConfig

- (CGSize)contentSize:(CGFloat)cellWidth
{
    
    <span class="f2">//BQMM集成</span>
<span class="f2">    NSDictionary *ext = self.message.remoteExt;</span>
<span class="f2">    if ([ext[@&quot;txt_msgType&quot;] isEqualToString:@&quot;facetype&quot;]) {</span>
<span class="f2">        return CGSizeMake(100, 100);</span>
<span class="f2">    }else{</span>
<span class="f2">//</span>        NSString *text = self.message.text;
<span class="f2">//</span>        [self.label nim_setText:text];
        CGFloat msgBubbleMaxWidth    = (cellWidth - 130);
        CGFloat bubbleLeftToContent  = 15;
        CGFloat contentRightToBubble = 0;
        CGFloat msgContentMaxWidth = (msgBubbleMaxWidth - contentRightToBubble - bubbleLeftToContent);
<span class="f2">//</span>        return [self.label sizeThatFits:CGSizeMake(msgContentMaxWidth, CGFLOAT_MAX)];
        
        <span class="f2">CGSize size = CGSizeZero;</span>
<span class="f2">        if (ext[@&quot;msg_data&quot;] != nil) {</span>
<span class="f2">            size = [MMTextParser sizeForMMTextWithExtData:ext[@&quot;msg_data&quot;] font:[UIFont systemFontOfSize:Chatroom_Message_Font_Size] maximumTextWidth:msgContentMaxWidth];</span>
<span class="f2">        }else{</span>
<span class="f2">            size = [MMTextParser sizeForTextWithText:self.message.text font:[UIFont systemFontOfSize:Chatroom_Message_Font_Size] maximumTextWidth:msgContentMaxWidth];</span>
<span class="f2">        }</span>
<span class="f2">        </span>
<span class="f2">        return size;</span>
<span class="f2">    }</span>
}

- (NSString *)cellContent
{
    <span class="f2">//BQMM集成</span>
<span class="f2">    NSDictionary *ext = self.message.remoteExt;</span>
<span class="f2">    if ([ext[@&quot;txt_msgType&quot;] isEqualToString:@&quot;facetype&quot;]) {</span>
<span class="f2">        return @&quot;NTESChatroomEmojiContentView&quot;;</span>
<span class="f2">    }else{</span>
        return @&quot;NTESChatroomTextContentView&quot;;
    <span class="f2">}</span>
    
}

- (UIEdgeInsets)contentViewInsets
<span class="f6">@@ -39,13 +68,13 @@</span> - (UIEdgeInsets)contentViewInsets
    return UIEdgeInsetsMake(20,15,10,0);
}

<span class="f2">//</span>- (NIMAttributedLabel *)label
<span class="f2">//</span>{
<span class="f2">//</span>    if (!_label) {
<span class="f2">//</span>        _label = [[NIMAttributedLabel alloc] initWithFrame:CGRectZero];
<span class="f2">//</span>        _label.font = [UIFont systemFontOfSize:Chatroom_Message_Font_Size];
<span class="f2">//</span>    }
<span class="f2">//</span>    return _label;
<span class="f2">//</span>}

@end
<span class="bold">diff --git a/ NIM_iOS_Demo_v2.9.0/NIMDemo/NIMDemo/Classes/Sections/Chatroom/NTESChatroomViewController.m b/ NIM_iOS_Demo_v2.9.0/NIMDemo/NIMDemo/Classes/Sections/Chatroom/NTESChatroomViewController.m</span>
<span class="bold">index e4f677d..e7eb8ec 100644</span>
<span class="bold">--- a/ NIM_iOS_Demo_v2.9.0/NIMDemo/NIMDemo/Classes/Sections/Chatroom/NTESChatroomViewController.m</span>	
<span class="bold">+++ b/ NIM_iOS_Demo_v2.9.0/NIMDemo/NIMDemo/Classes/Sections/Chatroom/NTESChatroomViewController.m</span>	
<span class="f6">@@ -62,7 +62,15 @@</span> - (void)onTapMediaItem:(NIMMediaItem *)item
- (void)sendMessage:(NIMMessage *)message
{
    NIMChatroomMember *member = [[NTESChatroomManager sharedInstance] myInfo:self.chatroom.roomId];
    <span class="f2">//BQMM集成</span>
<span class="f2">    if (message.remoteExt) {</span>
<span class="f2">        NSMutableDictionary *ret = [[NSMutableDictionary alloc] initWithDictionary:message.remoteExt];</span>
<span class="f2">        ret[@&quot;type&quot;] = @(member.type);</span>
<span class="f2">        message.remoteExt = ret;</span>
<span class="f2">    }else{</span>
        message.remoteExt = @{@&quot;type&quot;: @(member.type)};
    <span class="f2">}</span>
    
    [super sendMessage:message];
}

<span class="bold">diff --git a/ NIM_iOS_Demo_v2.9.0/NIMDemo/NIMDemo/Classes/Sections/Chatroom/View/SessionContentView/NTESChatroomEmojiContentView.h b/ NIM_iOS_Demo_v2.9.0/NIMDemo/NIMDemo/Classes/Sections/Chatroom/View/SessionContentView/NTESChatroomEmojiContentView.h
new file mode 100644</span>
<span class="bold">index 0000000..49efb30</span>
<span class="bold">--- /dev/null</span>
<span class="bold">+++ b/ NIM_iOS_Demo_v2.9.0/NIMDemo/NIMDemo/Classes/Sections/Chatroom/View/SessionContentView/NTESChatroomEmojiContentView.h</span>	
<span class="f6">@@ -0,0 +1,15 @@</span>
<span class="f2">//</span>
<span class="f2">//  NTESChatroomEmojiContentView.h</span>
<span class="f2">//  NIM</span>
<span class="f2">//</span>
<span class="f2">//  Created by isan on 11/10/2016.</span>
<span class="f2">//  Copyright © 2016 Netease. All rights reserved.</span>
<span class="f2">//</span>

<span class="f2">#import &quot;NIMSessionMessageContentView.h&quot;</span>

<span class="f2">@interface NTESChatroomEmojiContentView : NIMSessionMessageContentView</span>

<span class="f2">@property (nonatomic,strong,readonly) UIImageView * imageView;</span>

<span class="f2">@end</span>
<span class="bold">diff --git a/ NIM_iOS_Demo_v2.9.0/NIMDemo/NIMDemo/Classes/Sections/Chatroom/View/SessionContentView/NTESChatroomEmojiContentView.m b/ NIM_iOS_Demo_v2.9.0/NIMDemo/NIMDemo/Classes/Sections/Chatroom/View/SessionContentView/NTESChatroomEmojiContentView.m
new file mode 100644</span>
<span class="bold">index 0000000..4fc6e3e</span>
<span class="bold">--- /dev/null</span>
<span class="bold">+++ b/ NIM_iOS_Demo_v2.9.0/NIMDemo/NIMDemo/Classes/Sections/Chatroom/View/SessionContentView/NTESChatroomEmojiContentView.m</span>	
<span class="f6">@@ -0,0 +1,106 @@</span>
<span class="f2">//</span>
<span class="f2">//  NTESChatroomEmojiContentView.m</span>
<span class="f2">//  NIM</span>
<span class="f2">//</span>
<span class="f2">//  Created by isan on 11/10/2016.</span>
<span class="f2">//  Copyright © 2016 Netease. All rights reserved.</span>
<span class="f2">//</span>

<span class="f2">#import &quot;NTESChatroomEmojiContentView.h&quot;</span>
<span class="f2">#import &quot;NIMMessageModel.h&quot;</span>
<span class="f2">#import &quot;UIView+NIM.h&quot;</span>
<span class="f2">#import &quot;NIMLoadProgressView.h&quot;</span>

<span class="f2">//BQMM集成</span>
<span class="f2">#import &lt;BQMM/BQMM.h&gt;</span>

<span class="f2">@interface NTESChatroomEmojiContentView()</span>

<span class="f2">@property (nonatomic,strong,readwrite) UIImageView * imageView;</span>

<span class="f2">@property (nonatomic,strong) NIMLoadProgressView * progressView;</span>

<span class="f2">@end</span>

<span class="f2">@implementation NTESChatroomEmojiContentView</span>

<span class="f2">- (instancetype)initSessionMessageContentView{</span>
<span class="f2">    self = [super initSessionMessageContentView];</span>
<span class="f2">    if (self) {</span>
<span class="f2">        self.opaque = YES;</span>
<span class="f2">        _imageView  = [[UIImageView alloc] initWithFrame:CGRectZero];</span>
<span class="f2">        _imageView.backgroundColor = [UIColor clearColor];</span>
<span class="f2">        [self addSubview:_imageView];</span>
<span class="f2">        _progressView = [[NIMLoadProgressView alloc] initWithFrame:CGRectMake(0, 0, 44, 44)];</span>
<span class="f2">        _progressView.maxProgress = 1.0f;</span>
<span class="f2">        [self addSubview:_progressView];</span>
<span class="f2">        </span>
<span class="f2">    }</span>
<span class="f2">    return self;</span>
<span class="f2">}</span>

<span class="f2">- (void)refresh:(NIMMessageModel *)data{</span>
<span class="f2">    [super refresh:data];</span>
<span class="f2">    self.bubbleImageView.hidden = YES;</span>
<span class="f2">    //BQMM集成</span>
<span class="f2">    self.imageView.image = [UIImage imageNamed:@&quot;mm_emoji_loading&quot;];</span>
<span class="f2">    NSDictionary *ext = data.message.remoteExt;</span>
<span class="f2">    if ([ext[@&quot;txt_msgType&quot;] isEqualToString:@&quot;facetype&quot;]) {</span>
<span class="f2">        </span>
<span class="f2">        NSArray *codes = nil;</span>
<span class="f2">        if (ext[@&quot;msg_data&quot;]) {</span>
<span class="f2">            codes = @[ext[@&quot;msg_data&quot;][0][0]];</span>
<span class="f2">        }</span>
<span class="f2">        __weak typeof(self) weakself = self;</span>
<span class="f2">        [[MMEmotionCentre defaultCentre] fetchEmojisByType:MMFetchTypeBig codes:codes completionHandler:^(NSArray *emojis) {</span>
<span class="f2">            if (emojis.count &gt; 0) {</span>
<span class="f2">                MMEmoji *emoji = emojis[0];</span>
<span class="f2">                if ([codes[0] isEqualToString:emoji.emojiCode]) {</span>
<span class="f2">                    weakself.imageView.image = emoji.emojiImage; //TODO</span>
<span class="f2">                }</span>
<span class="f2">            }</span>
<span class="f2">            else {</span>
<span class="f2">                weakself.imageView.image = [UIImage imageNamed:@&quot;mm_emoji_error&quot;];</span>
<span class="f2">            }</span>
<span class="f2">        }];</span>
<span class="f2">    }</span>
<span class="f2">    self.progressView.hidden     = self.model.message.isOutgoingMsg ? (self.model.message.deliveryState != NIMMessageDeliveryStateDelivering) : (self.model.message.attachmentDownloadState != NIMMessageAttachmentDownloadStateDownloading);</span>
<span class="f2">    if (!self.progressView.hidden) {</span>
<span class="f2">        [self.progressView setProgress:[[[NIMSDK sharedSDK] chatManager] messageTransportProgress:self.model.message]];</span>
<span class="f2">    }</span>
<span class="f2">}</span>

<span class="f2">- (void)layoutSubviews{</span>
<span class="f2">    [super layoutSubviews];</span>
<span class="f2">    UIEdgeInsets contentInsets = self.model.contentViewInsets;</span>
<span class="f2">    CGSize contentSize = self.model.contentSize;</span>
<span class="f2">    CGRect imageViewFrame = CGRectMake(contentInsets.left, contentInsets.top, contentSize.width, contentSize.height);</span>
<span class="f2">    self.imageView.frame  = imageViewFrame;</span>
<span class="f2">    _progressView.frame   = self.bounds;</span>
<span class="f2">    </span>
<span class="f2">    CALayer *maskLayer = [CALayer layer];</span>
<span class="f2">    maskLayer.cornerRadius = 13.0;</span>
<span class="f2">    maskLayer.backgroundColor = [UIColor blackColor].CGColor;</span>
<span class="f2">    maskLayer.frame = self.imageView.bounds;</span>
<span class="f2">    self.imageView.layer.mask = maskLayer;</span>
<span class="f2">}</span>


<span class="f2">- (void)onTouchUpInside:(id)sender</span>
<span class="f2">{</span>
<span class="f2">    NIMKitEvent *event = [[NIMKitEvent alloc] init];</span>
<span class="f2">    event.eventName = NIMKitEventNameTapContent;</span>
<span class="f2">    event.messageModel = self.model;</span>
<span class="f2">    [self.delegate onCatchEvent:event];</span>
<span class="f2">}</span>

<span class="f2">- (void)updateProgress:(float)progress</span>
<span class="f2">{</span>
<span class="f2">    if (progress &gt; 1.0) {</span>
<span class="f2">        progress = 1.0;</span>
<span class="f2">    }</span>
<span class="f2">    self.progressView.progress = progress;</span>
<span class="f2">}</span>

<span class="f2">@end</span>

<span class="bold">diff --git a/ NIM_iOS_Demo_v2.9.0/NIMDemo/NIMDemo/Classes/Sections/Chatroom/View/SessionContentView/NTESChatroomTextContentView.h b/ NIM_iOS_Demo_v2.9.0/NIMDemo/NIMDemo/Classes/Sections/Chatroom/View/SessionContentView/NTESChatroomTextContentView.h</span>
<span class="bold">index 4ef5c31..d53bd83 100644</span>
<span class="bold">--- a/ NIM_iOS_Demo_v2.9.0/NIMDemo/NIMDemo/Classes/Sections/Chatroom/View/SessionContentView/NTESChatroomTextContentView.h</span>	
<span class="bold">+++ b/ NIM_iOS_Demo_v2.9.0/NIMDemo/NIMDemo/Classes/Sections/Chatroom/View/SessionContentView/NTESChatroomTextContentView.h</span>	
<span class="f6">@@ -9,10 +9,15 @@</span>

#import &quot;NIMSessionMessageContentView.h&quot;

<span class="f2">//BQMM集成</span>
<span class="f2">#import &quot;MMTextView.h&quot;</span>

@class NIMAttributedLabel;

@interface NTESChatroomTextContentView : NIMSessionMessageContentView

<span class="f1">@property</span><span class="f2">//BQMM集成</span>
<span class="f2">//@property</span> (nonatomic, strong) NIMAttributedLabel *textLabel;
<span class="f2">@property (nonatomic, strong) MMTextView *textMessageView;</span>

@end
<span class="bold">diff --git a/ NIM_iOS_Demo_v2.9.0/NIMDemo/NIMDemo/Classes/Sections/Chatroom/View/SessionContentView/NTESChatroomTextContentView.m b/ NIM_iOS_Demo_v2.9.0/NIMDemo/NIMDemo/Classes/Sections/Chatroom/View/SessionContentView/NTESChatroomTextContentView.m</span>
<span class="bold">index 7521d25..30bf04a 100644</span>
<span class="bold">--- a/ NIM_iOS_Demo_v2.9.0/NIMDemo/NIMDemo/Classes/Sections/Chatroom/View/SessionContentView/NTESChatroomTextContentView.m</span>	
<span class="bold">+++ b/ NIM_iOS_Demo_v2.9.0/NIMDemo/NIMDemo/Classes/Sections/Chatroom/View/SessionContentView/NTESChatroomTextContentView.m</span>	
<span class="f6">@@ -20,23 +20,32 @@</span> @implementation NTESChatroomTextContentView
- (instancetype)initSessionMessageContentView
{
    if (self = [super initSessionMessageContentView]) {
        <span class="f1">_textLabel</span><span class="f2">//BQMM集成</span>
<span class="f2">        _textMessageView</span> = [[<span class="f1">NIMAttributedLabel</span><span class="f2">MMTextView</span> alloc] <span class="f1">initWithFrame:CGRectZero</span><span class="f2">init</span>];
        <span class="f1">_textLabel</span><span class="f2">_textMessageView</span>.<span class="f1">autoDetectLinks</span><span class="f2">backgroundColor</span> = <span class="f1">NO</span><span class="f2">[UIColor clearColor]</span>;
        <span class="f1">_textLabel</span><span class="f2">_textMessageView</span>.<span class="f1">delegate</span><span class="f2">textContainerInset</span> = <span class="f1">self</span><span class="f2">UIEdgeInsetsZero</span>;
        <span class="f1">_textLabel</span><span class="f2">_textMessageView</span>.<span class="f1">numberOfLines</span><span class="f2">mmTextColor</span> = <span class="f1">0;</span>
<span class="f1">        _textLabel.lineBreakMode = NSLineBreakByWordWrapping</span><span class="f2">[UIColor blackColor]</span>;
        <span class="f1">_textLabel.font</span><span class="f2">_textMessageView.mmFont</span> = [UIFont systemFontOfSize:Chatroom_Message_Font_Size];
        <span class="f1">_textLabel</span><span class="f2">_textMessageView.editable = false;</span>
<span class="f2">        _textMessageView</span>.<span class="f1">backgroundColor</span><span class="f2">selectable</span> = <span class="f1">[UIColor clearColor]</span><span class="f2">false</span>;
        <span class="f1">_textLabel</span><span class="f2">_textMessageView</span>.<span class="f1">textColor</span><span class="f2">scrollEnabled</span> = <span class="f1">[UIColor blackColor]</span><span class="f2">false;</span>
<span class="f2">        _textMessageView.clickActionDelegate = self</span>;
        [self addSubview:<span class="f1">_textLabel</span><span class="f2">_textMessageView</span>];
        
        
    }
    return self;
}

- (void)refresh:(NIMMessageModel *)model{
    [super refresh:model];
    <span class="f1">NSString</span><span class="f2">//BQMM集成</span>
<span class="f2">    NSDictionary</span> *<span class="f1">text</span><span class="f2">extDic</span> =<span class="f1">self.</span> model.message.<span class="f1">text</span><span class="f2">remoteExt</span>;
    <span class="f2">if(extDic[@&quot;msg_data&quot;] != nil) {</span>
        [<span class="f1">_textLabel nim_setText</span><span class="f2">_textMessageView setMmTextData</span>:<span class="f1">text</span><span class="f2">extDic[@&quot;msg_data&quot;</span>]<span class="f2">];</span>
<span class="f2">    }else{</span>
<span class="f2">        _textMessageView.text = model.message.text</span>;
    <span class="f2">}</span>
}

- (void)layoutSubviews{
<span class="f6">@@ -44,7 +53,8 @@</span> - (void)layoutSubviews{
    UIEdgeInsets contentInsets = self.model.contentViewInsets;
    CGSize contentsize         = self.model.contentSize;
    CGRect labelFrame = CGRectMake(contentInsets.left, contentInsets.top, contentsize.width, contentsize.height);
    <span class="f1">self.textLabel</span><span class="f2">//BQMM集成</span>
<span class="f2">    _textMessageView</span>.frame = labelFrame;
}


<span class="bold">diff --git a/ NIM_iOS_Demo_v2.9.0/NIMDemo/NIMDemo/Classes/Sections/Session/ViewController/NTESSessionViewController.m b/ NIM_iOS_Demo_v2.9.0/NIMDemo/NIMDemo/Classes/Sections/Session/ViewController/NTESSessionViewController.m</span>
<span class="bold">index 5ed30f7..20a30a3 100644</span>
<span class="bold">--- a/ NIM_iOS_Demo_v2.9.0/NIMDemo/NIMDemo/Classes/Sections/Session/ViewController/NTESSessionViewController.m</span>	
<span class="bold">+++ b/ NIM_iOS_Demo_v2.9.0/NIMDemo/NIMDemo/Classes/Sections/Session/ViewController/NTESSessionViewController.m</span>	
<span class="f6">@@ -49,6 +49,8 @@</span>
#import &quot;NTESDataManager.h&quot;
#import &quot;NTESSessionUtil.h&quot;

<span class="f2">//BQMM集成</span>
<span class="f2">#import &lt;BQMM/BQMM.h&gt;</span>
typedef enum : NSUInteger {
    NTESImagePickerModeImage,
    NTESImagePickerModeSnapChat,
<span class="f6">@@ -481,19 +483,31 @@</span> - (void)onTapCell:(NIMKitEvent *)event
        NSDictionary *actions = [self cellActions];
        NSString *value = actions[@(message.messageType)];
        if (value) {
            <span class="f2">//BQMM集成</span>
<span class="f2">            if ([value isEqualToString:@&quot;textContentAction&quot;]) {</span>
<span class="f2">                NSDictionary *extDic = message.remoteExt;</span>
<span class="f2">                if (extDic != nil &amp;&amp; [extDic[@&quot;txt_msgType&quot;] isEqualToString: @&quot;facetype&quot;]) {</span>
<span class="f2">                    SEL selector = NSSelectorFromString(@&quot;showEmojiDetail:&quot;);</span>
<span class="f2">                    if (selector &amp;&amp; [self respondsToSelector:selector]) {</span>
<span class="f2">                        SuppressPerformSelectorLeakWarning([self performSelector:selector withObject:message]);</span>
<span class="f2">                        handled = YES;</span>
<span class="f2">                    }</span>
<span class="f2">                }</span>
<span class="f2">            }else{</span>
                SEL selector = NSSelectorFromString(value);
                if (selector &amp;&amp; [self respondsToSelector:selector]) {
                    SuppressPerformSelectorLeakWarning([self performSelector:selector withObject:message]);
                    handled = YES;
                <span class="f2">}</span>
            }
        }
    }
    else if([eventName isEqualToString:NIMKitEventNameTapLabelLink])
    {
        <span class="f2">//BQMM集成</span>
        NSString *link = event.data;
        <span class="f2">NSURL *linkUrl =</span> [<span class="f1">self.view makeToast:</span>[<span class="f1">NSString stringWithFormat:@&quot;tap link</span><span class="f2">NSURL alloc] initWithString</span>:<span class="f1">%@&quot;,</span>link]<span class="f1">duration:2</span>
<span class="f1">                    position</span><span class="f2">;</span>
<span class="f2">        [[UIApplication sharedApplication] openURL</span>:<span class="f1">CSToastPositionCenter</span><span class="f2">linkUrl</span>];
        handled = YES;
    }
    else if([eventName isEqualToString:NIMDemoEventNameOpenSnapPicture])
<span class="f6">@@ -552,6 +566,15 @@</span> - (void)onTapAvatar:(NSString *)userId{


#pragma mark - Cell Actions
<span class="f2">//BQMM集成</span>
<span class="f2">- (void)showEmojiDetail:(NIMMessage *)message {</span>
<span class="f2">    NSDictionary *extDic = message.remoteExt;</span>
<span class="f2">    if (extDic != nil &amp;&amp; [extDic[@&quot;txt_msgType&quot;] isEqualToString: @&quot;facetype&quot;]) {</span>
<span class="f2">        UIViewController *emojiController = [[MMEmotionCentre defaultCentre] controllerForEmotionCode:extDic[@&quot;msg_data&quot;][0][0]];</span>
<span class="f2">        [self.navigationController pushViewController:emojiController animated:YES];</span>
<span class="f2">    }</span>
<span class="f2">}</span>

- (void)showImage:(NIMMessage *)message
{
    NIMImageObject *object = message.messageObject;
<span class="f6">@@ -829,7 +852,9 @@</span> - (NSDictionary *)cellActions
    static NSDictionary *actions = nil;
    static dispatch_once_t onceToken;
    dispatch_once(&amp;onceToken, ^{
        <span class="f2">//BQMM集成</span>
        actions = @{@(<span class="f2">NIMMessageTypeText) :     @&quot;textContentAction&quot;,</span>
<span class="f2">                    @(</span>NIMMessageTypeImage) :    @&quot;showImage:&quot;,
                    @(NIMMessageTypeAudio) :    @&quot;playAudio:&quot;,
                    @(NIMMessageTypeVideo) :    @&quot;showVideo:&quot;,
                    @(NIMMessageTypeLocation) : @&quot;showLocation:&quot;,
<span class="bold">diff --git a/ NIM_iOS_Demo_v2.9.0/NIMDemo/NIMDemo/NTESAppDelegate.m b/ NIM_iOS_Demo_v2.9.0/NIMDemo/NIMDemo/NTESAppDelegate.m</span>
<span class="bold">index e4e422f..587882c 100644</span>
<span class="bold">--- a/ NIM_iOS_Demo_v2.9.0/NIMDemo/NIMDemo/NTESAppDelegate.m</span>	
<span class="bold">+++ b/ NIM_iOS_Demo_v2.9.0/NIMDemo/NIMDemo/NTESAppDelegate.m</span>	
<span class="f6">@@ -23,6 +23,9 @@</span>
#import &quot;NIMKit.h&quot;
#import &quot;NTESDataManager.h&quot;
#import &quot;NTESSDKConfig.h&quot;
<span class="f2">#import &quot;NIMUIConfig.h&quot;</span>
<span class="f2">//BQMM集成</span>
<span class="f2">#import &lt;BQMM/BQMM.h&gt;</span>

NSString *NTESNotificationLogout = @&quot;NTESNotificationLogout&quot;;
@interface NTESAppDelegate ()&lt;NIMLoginManagerDelegate&gt;
<span class="f6">@@ -40,7 +43,18 @@</span> - (BOOL)application:(UIApplication *)application didFinishLaunchingWithOptions:(
    _config = [[NTESSDKConfig alloc] init];
    [[NIMSDKConfig sharedConfig] setDelegate:_config];
    
    <span class="f2">//BQMM集成  BQMM初始化</span>
<span class="f2">    NSString *appId = @&quot;appId&quot;;</span>
<span class="f2">    NSString *secret = @&quot;appSecret&quot;;</span>
<span class="f2">    [[MMEmotionCentre defaultCentre] setAppId:appId</span>
<span class="f2">                                       secret:secret];</span>
    
    <span class="f2">MMTheme *theme = [[MMTheme alloc] init];</span>
<span class="f2">    theme.keyboardHeight = [NIMUIConfig bottomInputViewHeight];</span>
<span class="f2">    [[MMEmotionCentre defaultCentre] setTheme:theme];</span>
<span class="f2">    [MMEmotionCentre defaultCentre].sdkMode = MMSDKModeIM;</span>
<span class="f2">    [MMEmotionCentre defaultCentre].sdkLanguage = MMLanguageChinese;</span>
<span class="f2">    [MMEmotionCentre defaultCentre].sdkRegion = MMRegionOther;</span>
    
    //appkey是应用的标识，不同应用之间的数据（用户、消息、群组等）是完全隔离的。
    //如需打网易云信Demo包，请勿修改appkey，开发自己的应用时，请替换为自己的appkey.
<span class="f6">@@ -89,6 +103,8 @@</span> - (void)applicationDidEnterBackground:(UIApplication *)application {
}

- (void)applicationWillEnterForeground:(UIApplication *)application {
    <span class="f2">//BQMM集成</span>
<span class="f2">    [[MMEmotionCentre defaultCentre] clearSession];</span>
}

- (void)applicationDidBecomeActive:(UIApplication *)application {
<span class="bold">diff --git a/ NIM_iOS_Demo_v2.9.0/NIMKit/NIMKit/Classes/Sections/Input/NIMInputView.h b/ NIM_iOS_Demo_v2.9.0/NIMKit/NIMKit/Classes/Sections/Input/NIMInputView.h</span>
<span class="bold">index 5e3d213..947a11a 100644</span>
<span class="bold">--- a/ NIM_iOS_Demo_v2.9.0/NIMKit/NIMKit/Classes/Sections/Input/NIMInputView.h</span>	
<span class="bold">+++ b/ NIM_iOS_Demo_v2.9.0/NIMKit/NIMKit/Classes/Sections/Input/NIMInputView.h</span>	
<span class="f6">@@ -10,10 +10,10 @@</span>
#import &quot;NIMInputTextView.h&quot;
#import &quot;NIMInputProtocol.h&quot;
#import &quot;NIMSessionConfig.h&quot;
<span class="f2">//BQMM集成</span>
<span class="f2">#import &quot;NIMInputToolBar.h&quot;</span>
@class NIMInputMoreContainerView;
@class NIMInputEmoticonContainerView;
<span class="f1">@class NIMInputToolBar;</span>

typedef NS_ENUM(NSInteger, NIMInputType){
    InputTypeText = 1,
<span class="f6">@@ -50,7 +50,9 @@</span> typedef NS_ENUM(NSInteger, NIMAudioRecordPhase) {

@property (strong, nonatomic)  NIMInputToolBar *toolBar;
@property (strong, nonatomic)  NIMInputMoreContainerView *moreContainer;
<span class="f1">@property</span><span class="f2">//BQMM集成</span>
<span class="f2">//@property</span> (strong, nonatomic)  NIMInputEmoticonContainerView *emoticonContainer;
<span class="f2">@property (nonatomic) NIMInputType inputType;</span>

- (instancetype)initWithFrame:(CGRect)frame;

<span class="f6">@@ -64,4 +66,9 @@</span> typedef NS_ENUM(NSInteger, NIMAudioRecordPhase) {
- (void)updateAudioRecordTime:(NSTimeInterval)time;
- (void)updateVoicePower:(float)power;


<span class="f2">//BQMM集成</span>
<span class="f2">- (void)inputTextViewToHeight:(CGFloat)toHeight;</span>
<span class="f2">- (CGFloat)getTextViewContentH:(UITextView *)textView;</span>

@end
<span class="bold">diff --git a/ NIM_iOS_Demo_v2.9.0/NIMKit/NIMKit/Classes/Sections/Input/NIMInputView.m b/ NIM_iOS_Demo_v2.9.0/NIMKit/NIMKit/Classes/Sections/Input/NIMInputView.m</span>
<span class="bold">index 2558346..a95e580 100644</span>
<span class="bold">--- a/ NIM_iOS_Demo_v2.9.0/NIMKit/NIMKit/Classes/Sections/Input/NIMInputView.m</span>	
<span class="bold">+++ b/ NIM_iOS_Demo_v2.9.0/NIMKit/NIMKit/Classes/Sections/Input/NIMInputView.m</span>	
<span class="f6">@@ -19,11 +19,12 @@</span>
#import &quot;NIMUIConfig.h&quot;
#import &quot;NIMGlobalMacro.h&quot;

<span class="f2">//BQMM集成</span>
<span class="f2">#import &lt;BQMM/BQMM.h&gt;</span>
@interface NIMInputView()&lt;UITextViewDelegate,NIMInputEmoticonProtocol&gt;
{
    <span class="f2">//BQMM集成</span>
    UIView  *_emoticonView;
<span class="f1">    NIMInputType  _inputType;</span>
    CGFloat   _inputTextViewOlderHeight;
}

<span class="f6">@@ -72,7 +73,8 @@</span> - (void)setInputConfig:(id&lt;NIMSessionConfig&gt;)config
        [_toolBar setInputBarItemTypes:types];
    }
    _moreContainer.config     = config;
    <span class="f2">//BQMM集成</span>
<span class="f2">//</span>    _emoticonContainer.config = config;
}

- (void)setInputDelegate:(id&lt;NIMInputDelegate&gt;)delegate
<span class="f6">@@ -152,17 +154,19 @@</span> - (void)initUIComponents
    _moreContainer.hidden   = YES;
    [self addSubview:_moreContainer];
    
    <span class="f2">//BQMM集成</span>
<span class="f2">//</span>    _emoticonContainer = [[NIMInputEmoticonContainerView alloc] initWithFrame:CGRectMake(0, [NIMUIConfig topInputViewHeight], self.nim_width, [NIMUIConfig bottomInputViewHeight])];
<span class="f2">//</span>    _emoticonContainer.autoresizingMask = UIViewAutoresizingFlexibleWidth;
<span class="f2">//</span>    _emoticonContainer.delegate = self;
<span class="f2">//</span>    _emoticonContainer.hidden = YES;
<span class="f2">//</span>    [self addSubview:_emoticonContainer];
}

- (void)dealloc
{
    [[NSNotificationCenter defaultCenter] removeObserver:self];
    <span class="f2">//BQMM集成</span>
<span class="f2">//</span>    _emoticonContainer.delegate = nil;
    _toolBar.inputTextView.delegate = nil;
}

<span class="f6">@@ -346,7 +350,8 @@</span> - (void)updateInputTopViewFrame:(CGRect)rect
    self.toolBar.frame             = rect;
    [self.toolBar layoutIfNeeded];
    self.moreContainer.nim_top     = self.toolBar.nim_bottom;
    <span class="f2">//BQMM集成</span>
<span class="f2">//</span>    self.emoticonContainer.nim_top = self.toolBar.nim_bottom;
}


<span class="f6">@@ -418,14 +423,14 @@</span> - (IBAction)onTouchRecordBtnDragOutside:(id)sender {
- (void)onTouchEmoticonBtn:(id)sender
{
    if (_inputType != InputTypeEmot) {
        <span class="f2">//BQMM集成</span>
        _inputType = InputTypeEmot;
        <span class="f2">//切换BQMM键盘</span>
<span class="f2">        self.toolBar.inputTextView.selectedRange = NSMakeRange(self.toolBar.inputTextView.text.length,0);</span>
<span class="f2">        [[MMEmotionCentre defaultCentre] attachEmotionKeyboardToInput:self.toolBar.inputTextView];</span>
<span class="f2">        [self.toolBar.inputTextView becomeFirstResponder];</span>
        _inputBottomViewHeight = [NIMUIConfig bottomInputViewHeight];
<span class="f1">        [self bringSubviewToFront:_emoticonContainer];</span>
        [_moreContainer setHidden:YES];
<span class="f1">        [_emoticonContainer setHidden:NO];</span>
<span class="f1">        if ([self.toolBar.inputTextView isFirstResponder]) {</span>
<span class="f1">            [self.toolBar.inputTextView resignFirstResponder];</span>
<span class="f1">        }</span>
        [UIView animateWithDuration:0.25 animations:^{
            [self willShowBottomHeight:_inputBottomViewHeight];
        }];
<span class="f6">@@ -434,6 +439,8 @@</span> - (void)onTouchEmoticonBtn:(id)sender
        _inputBottomViewHeight = 0;
        _inputType = InputTypeText;
        [self.toolBar.inputTextView becomeFirstResponder];
        <span class="f2">//BQMM集成</span>
<span class="f2">        [[MMEmotionCentre defaultCentre] switchToDefaultKeyboard];</span>
    }
    [self updateAllButtonImages];
}
<span class="f6">@@ -443,7 +450,8 @@</span> - (void)onTouchMoreBtn:(id)sender {
        _inputType = InputTypeMedia;
        [self bringSubviewToFront:_moreContainer];
        [_moreContainer setHidden:NO];
        <span class="f2">//BQMM集成</span>
<span class="f2">//</span>        [_emoticonContainer setHidden:YES];
        _inputBottomViewHeight = [NIMUIConfig bottomInputViewHeight];
        if ([self.toolBar.inputTextView isFirstResponder]) {
            [self.toolBar.inputTextView resignFirstResponder];
<span class="f6">@@ -478,7 +486,8 @@</span> - (BOOL)endEditing:(BOOL)force

- (void)textViewDidBeginEditing:(UITextView *)textView
{
    <span class="f2">//BQMM集成</span>
<span class="f2">//</span>    _inputType = InputTypeText;
    [textView becomeFirstResponder];
}

<span class="bold">diff --git a/ NIM_iOS_Demo_v2.9.0/NIMKit/NIMKit/Classes/Sections/Session/Config/NIMTextContentConfig.m b/ NIM_iOS_Demo_v2.9.0/NIMKit/NIMKit/Classes/Sections/Session/Config/NIMTextContentConfig.m</span>
<span class="bold">index 14bbee4..f22c6df 100644</span>
<span class="bold">--- a/ NIM_iOS_Demo_v2.9.0/NIMKit/NIMKit/Classes/Sections/Session/Config/NIMTextContentConfig.m</span>	
<span class="bold">+++ b/ NIM_iOS_Demo_v2.9.0/NIMKit/NIMKit/Classes/Sections/Session/Config/NIMTextContentConfig.m</span>	
<span class="f6">@@ -8,9 +8,16 @@</span>

#import &quot;NIMTextContentConfig.h&quot;
#import &quot;NIMAttributedLabel+NIMKit.h&quot;

<span class="f2">//BQMM集成</span>
<span class="f2">#import &lt;BQMM/BQMM.h&gt;</span>
<span class="f2">#import &quot;MMTextParser.h&quot;</span>
<span class="f2">#import &quot;MMTextView.h&quot;</span>
@interface NIMTextContentConfig()

<span class="f2">//BQMM集成</span>
<span class="f2">//</span>@property (nonatomic,strong) NIMAttributedLabel *label;
<span class="f2">@property (nonatomic, strong) MMTextView *textMessageView;</span>

@end

<span class="f6">@@ -19,35 +26,58 @@</span> @implementation NIMTextContentConfig

- (CGSize)contentSize:(CGFloat)cellWidth
{
    <span class="f2">//BQMM集成</span>
<span class="f2">    NSDictionary *ext = self.message.remoteExt;</span>
<span class="f2">    if ([ext[@&quot;txt_msgType&quot;] isEqualToString:@&quot;facetype&quot;]) {</span>
<span class="f2">        return CGSizeMake(140, 140);</span>
<span class="f2">    }else{</span>
<span class="f2">//</span>        NSString *text = self.message.text;
<span class="f2">//</span>        [self.label nim_setText:text];
        
        CGFloat msgBubbleMaxWidth    = (cellWidth - 130);
        CGFloat bubbleLeftToContent  = 14;
        CGFloat contentRightToBubble = 14;
        CGFloat msgContentMaxWidth = (msgBubbleMaxWidth - contentRightToBubble - bubbleLeftToContent);
<span class="f2">//</span>        return [self.label sizeThatFits:CGSizeMake(msgContentMaxWidth, CGFLOAT_MAX)];
        
        
        <span class="f2">CGSize size = CGSizeZero;</span>
<span class="f2">        if (ext[@&quot;msg_data&quot;] != nil) {</span>
<span class="f2">            size = [MMTextParser sizeForMMTextWithExtData:ext[@&quot;msg_data&quot;] font:[UIFont systemFontOfSize:NIMKit_Message_Font_Size] maximumTextWidth:msgContentMaxWidth];</span>
<span class="f2">        }else{</span>
<span class="f2">            size = [MMTextParser sizeForTextWithText:self.message.text font:[UIFont systemFontOfSize:NIMKit_Message_Font_Size] maximumTextWidth:msgContentMaxWidth];</span>
<span class="f2">        }</span>
<span class="f2">        </span>
<span class="f2">        return size;</span>
<span class="f2">    }</span>
}

- (NSString *)cellContent
{
    <span class="f2">//BQMM集成</span>
<span class="f2">    NSDictionary *ext = self.message.remoteExt;</span>
<span class="f2">    if ([ext[@&quot;txt_msgType&quot;] isEqualToString:@&quot;facetype&quot;]) {</span>
<span class="f2">        return @&quot;NIMSessionEmojiContentView&quot;;</span>
<span class="f2">    }else{</span>
        return @&quot;NIMSessionTextContentView&quot;;
    <span class="f2">}</span>
    
}

- (UIEdgeInsets)contentViewInsets
{
    return self.message.isOutgoingMsg ? UIEdgeInsetsMake(<span class="f1">11</span><span class="f2">9</span>,11,<span class="f1">9</span><span class="f2">11</span>,15) : UIEdgeInsetsMake(<span class="f1">11</span><span class="f2">9</span>,15,<span class="f1">9</span><span class="f2">11</span>,9);
}


<span class="f2">//</span>- (NIMAttributedLabel *)label
<span class="f2">//</span>{
<span class="f2">//</span>    if (_label) {
<span class="f2">//</span>        return _label;
<span class="f2">//</span>    }
<span class="f2">//</span>    _label = [[NIMAttributedLabel alloc] initWithFrame:CGRectZero];
<span class="f2">//</span>    _label.font = [UIFont systemFontOfSize:NIMKit_Message_Font_Size];
<span class="f2">//</span>    return _label;
<span class="f2">//</span>}

@end
<span class="bold">diff --git a/ NIM_iOS_Demo_v2.9.0/NIMKit/NIMKit/Classes/Sections/Session/NIMSessionViewController.m b/ NIM_iOS_Demo_v2.9.0/NIMKit/NIMKit/Classes/Sections/Session/NIMSessionViewController.m</span>
<span class="bold">index 484b26b..ed18751 100644</span>
<span class="bold">--- a/ NIM_iOS_Demo_v2.9.0/NIMKit/NIMKit/Classes/Sections/Session/NIMSessionViewController.m</span>	
<span class="bold">+++ b/ NIM_iOS_Demo_v2.9.0/NIMKit/NIMKit/Classes/Sections/Session/NIMSessionViewController.m</span>	
<span class="f6">@@ -23,7 +23,8 @@</span>
#import &quot;NIMMessageCellMaker.h&quot;
#import &quot;NIMUIConfig.h&quot;
#import &quot;NIMKit.h&quot;
<span class="f2">//BQMM集成</span>
<span class="f2">#import &quot;MMTextParser.h&quot;</span>

static const void * const NTESDispatchMessageDataPrepareSpecificKey = &amp;NTESDispatchMessageDataPrepareSpecificKey;
dispatch_queue_t NTESMessageDataPrepareQueue()
<span class="f6">@@ -42,7 +43,8 @@</span> @interface NIMSessionViewController ()
NIMConversationManagerDelegate,
NIMMediaManagerDelgate,
NIMMessageCellDelegate,
NIMUserManagerDelegate<span class="f2">,</span>
<span class="f2">MMEmotionCentreDelegate</span>&gt;<span class="f2">//BQMM集成</span>

@property (nonatomic,strong,readwrite) UITableView *tableView;

<span class="f6">@@ -68,6 +70,9 @@</span> - (void)viewDidLoad {
    [super viewDidLoad];
    [self makeUI];
    [self makeHandlerAndDataSource];
    
    <span class="f2">//BQMM集成</span>
<span class="f2">    [[MMEmotionCentre defaultCentre] shouldShowShotcutPopoverAboveView:_sessionInputView.toolBar.emoticonBtn withInput:_sessionInputView.toolBar.inputTextView];</span>
}


<span class="f6">@@ -85,6 +90,8 @@</span> - (void)makeUI
{
    self.navigationItem.title = [self sessionTitle];
    NIMCustomLeftBarView *leftBarView = [[NIMCustomLeftBarView alloc] init];
    <span class="f2">//BQMM集成</span>
<span class="f2">    leftBarView.tag = 1000;</span>
    UIBarButtonItem *leftItem = [[UIBarButtonItem alloc] initWithCustomView:leftBarView];
    self.navigationItem.leftBarButtonItem = leftItem;
    self.navigationItem.leftItemsSupplementBackButton = YES;
<span class="f6">@@ -173,6 +180,15 @@</span> - (void)viewWillAppear:(BOOL)animated
    //fix bug: 竖屏进入会话界面，然后右上角进入群信息，再横屏，左上角返回，横屏的会话界面显示的就是竖屏时的大小
    [self.sessionDatasource cleanCache];
    [self.tableView reloadData];
    
    <span class="f2">//BQMM集成</span>
<span class="f2">    [MMEmotionCentre defaultCentre].delegate = self;</span>
<span class="f2">}</span>

<span class="f2">- (void)viewWillDisappear:(BOOL)animated {</span>
<span class="f2">    //BQMM集成</span>
<span class="f2">    [MMEmotionCentre defaultCentre].delegate = nil;</span>
<span class="f2">    [super viewWillDisappear:animated];</span>
}

- (void)viewDidDisappear:(BOOL)animated{
<span class="f6">@@ -503,7 +519,31 @@</span> - (void)onTextChanged:(id)sender{}

- (void)onSendText:(NSString *)text
{
    <span class="f2">//BQMM集成</span>
<span class="f2">    NSMutableCharacterSet *set = [NSMutableCharacterSet whitespaceCharacterSet];</span>
<span class="f2">    NSString *sendStr = _sessionInputView.toolBar.inputTextView.characterMMText;</span>
<span class="f2">    NSArray *textImgArray = _sessionInputView.toolBar.inputTextView.textImgArray;</span>
<span class="f2">    NSDictionary *mmExt = @{@&quot;txt_msgType&quot;:@&quot;emojitype&quot;,</span>
<span class="f2">                            @&quot;msg_data&quot;:[MMTextParser extDataWithTextImageArray:textImgArray]};;</span>
<span class="f2">    if (sendStr.length == 0) {</span>
<span class="f2">        UIAlertView * alert = [[UIAlertView alloc]initWithTitle:nil message:@&quot;不能发送空白消息&quot; delegate:nil cancelButtonTitle:@&quot;确定&quot; otherButtonTitles:nil];</span>
<span class="f2">        [alert show];</span>
<span class="f2">        return;</span>
<span class="f2">    }</span>
<span class="f2">    </span>
<span class="f2">    </span>
<span class="f2">    NSString *extString = nil;</span>
<span class="f2">    if (mmExt) {</span>
<span class="f2">        NSError *parseError = nil;</span>
<span class="f2">        NSData  *extData = [NSJSONSerialization dataWithJSONObject:mmExt</span>
<span class="f2">                                                           options:NSJSONWritingPrettyPrinted error:&amp;parseError];</span>
<span class="f2">        extString = [[NSString alloc] initWithData:extData encoding:NSUTF8StringEncoding];</span>
<span class="f2">        extString = [extString stringByTrimmingCharactersInSet:[NSCharacterSet whitespaceCharacterSet]];</span>
<span class="f2">    }</span>
    
    NIMMessage *message = [NIMMessageMaker msgWithText:<span class="f1">text</span><span class="f2">sendStr</span>];
    <span class="f2">message.remoteExt = mmExt;</span>

    [self sendMessage:message];
}

<span class="f6">@@ -581,8 +621,12 @@</span> - (NSArray *)menusItems:(NIMMessage *)message
    NSMutableArray *items = [NSMutableArray array];
    
    if (message.messageType == NIMMessageTypeText) {
        <span class="f2">//BQMM集成</span>
<span class="f2">        NSDictionary *ext = message.remoteExt;</span>
<span class="f2">        if (![ext[@&quot;txt_msgType&quot;] isEqualToString:@&quot;facetype&quot;]) {</span>
            [items addObject:[[UIMenuItem alloc] initWithTitle:@&quot;复制&quot;
                                                        action:@selector(copyText:)]];
        <span class="f2">}</span>
    }
    [items addObject:[[UIMenuItem alloc] initWithTitle:@&quot;删除&quot;
                                                action:@selector(deleteMsg:)]];
<span class="f6">@@ -615,10 +659,17 @@</span> - (BOOL)canPerformAction:(SEL)action withSender:(id)sender

- (void)copyText:(id)sender
{
    <span class="f2">//BQMM集成</span>
    NIMMessage *message = [self messageForMenu];
    if (message.text.length) {
        UIPasteboard *pasteboard = [UIPasteboard generalPasteboard];
        
        <span class="f2">NSDictionary *extDic = message.remoteExt;</span>
<span class="f2">        if (extDic != nil &amp;&amp; [extDic[@&quot;txt_msgType&quot;] isEqualToString:@&quot;emojitype&quot;]) {</span>
<span class="f2">            pasteboard.string = [MMTextParser stringWithExtData:extDic[@&quot;msg_data&quot;]];</span>
<span class="f2">        }else{</span>
            [pasteboard setString:message.text];
        <span class="f2">}</span>
    }
}

<span class="f6">@@ -935,5 +986,52 @@</span> - (void)checkReceipt
    }
}

<span class="f2">//BQMM集成</span>
<span class="f2">//#pragma mark - MMEmotionCentreDelegate</span>
<span class="f2">- (void)didSelectEmoji:(MMEmoji *)emoji</span>
<span class="f2">{</span>
<span class="f2">    [self sendMMFace:emoji];</span>
<span class="f2">}</span>

<span class="f2">- (void)didSelectTipEmoji:(MMEmoji *)emoji</span>
<span class="f2">{</span>
<span class="f2">    [self sendMMFace:emoji];</span>
<span class="f2">    _sessionInputView.toolBar.inputTextView.text = @&quot;&quot;;</span>
<span class="f2">}</span>

<span class="f2">- (void)didSendWithInput:(UIResponder&lt;UITextInput&gt; *)input</span>
<span class="f2">{</span>
<span class="f2">    UITextView *textView = (UITextView *)input;</span>
<span class="f2">    [self onSendText:textView.text];</span>
<span class="f2">    [textView layoutIfNeeded];</span>
<span class="f2">    textView.text = @&quot;&quot;;</span>
<span class="f2">    [textView layoutIfNeeded];</span>
<span class="f2">    [_sessionInputView inputTextViewToHeight:[_sessionInputView getTextViewContentH:textView]];</span>
<span class="f2">}</span>

<span class="f2">- (void)tapOverlay</span>
<span class="f2">{</span>
<span class="f2">    _sessionInputView.inputType = InputTypeText;</span>
<span class="f2">}</span>

<span class="f2">#pragma mark private</span>
<span class="f2">-(void)sendMMFace:(MMEmoji *)emoji {</span>
<span class="f2">    NSDictionary *mmExt = @{@&quot;txt_msgType&quot;:@&quot;facetype&quot;,</span>
<span class="f2">                            @&quot;msg_data&quot;:@[@[emoji.emojiCode, [NSString stringWithFormat:@&quot;%d&quot;, emoji.isEmoji ? 1 : 2]]]};</span>
<span class="f2">    NSString *extString = nil;</span>
<span class="f2">    if (mmExt) {</span>
<span class="f2">        NSError *parseError = nil;</span>
<span class="f2">        NSData  *extData = [NSJSONSerialization dataWithJSONObject:mmExt</span>
<span class="f2">                                                           options:NSJSONWritingPrettyPrinted error:&amp;parseError];</span>
<span class="f2">        extString = [[NSString alloc] initWithData:extData encoding:NSUTF8StringEncoding];</span>
<span class="f2">        extString = [extString stringByTrimmingCharactersInSet:[NSCharacterSet whitespaceCharacterSet]];</span>
<span class="f2">    }</span>
<span class="f2">    NSString *sendStr = [NSString stringWithFormat:@&quot;[%@]&quot;, emoji.emojiName];</span>
<span class="f2">    NIMMessage *message = [NIMMessageMaker msgWithText:sendStr];</span>
<span class="f2">    message.remoteExt = mmExt;</span>
<span class="f2">    </span>
<span class="f2">    [self sendMessage:message];</span>
<span class="f2">}</span>

@end

<span class="bold">diff --git a/ NIM_iOS_Demo_v2.9.0/NIMKit/NIMKit/Classes/Sections/Session/View/SessionContentView/NIMSessionEmojiContentView.h b/ NIM_iOS_Demo_v2.9.0/NIMKit/NIMKit/Classes/Sections/Session/View/SessionContentView/NIMSessionEmojiContentView.h</span>
<span class="bold">new file mode 100644</span>
<span class="bold">index 0000000..cc216aa</span>
<span class="bold">--- /dev/null</span>
<span class="bold">+++ b/ NIM_iOS_Demo_v2.9.0/NIMKit/NIMKit/Classes/Sections/Session/View/SessionContentView/NIMSessionEmojiContentView.h</span>	
<span class="f6">@@ -0,0 +1,15 @@</span>
<span class="f2">//</span>
<span class="f2">//  NIMSessionEmojiContentView.h</span>
<span class="f2">//  NIMKit</span>
<span class="f2">//</span>
<span class="f2">//  Created by isan on 10/10/2016.</span>
<span class="f2">//  Copyright © 2016 NetEase. All rights reserved.</span>
<span class="f2">//</span>

<span class="f2">#import &quot;NIMSessionMessageContentView.h&quot;</span>

<span class="f2">@interface NIMSessionEmojiContentView : NIMSessionMessageContentView</span>

<span class="f2">@property (nonatomic,strong,readonly) UIImageView * imageView;</span>

<span class="f2">@end</span>
<span class="bold">diff --git a/ NIM_iOS_Demo_v2.9.0/NIMKit/NIMKit/Classes/Sections/Session/View/SessionContentView/NIMSessionEmojiContentView.m b/ NIM_iOS_Demo_v2.9.0/NIMKit/NIMKit/Classes/Sections/Session/View/SessionContentView/NIMSessionEmojiContentView.m</span>
<span class="bold">new file mode 100644</span>
<span class="bold">index 0000000..bf223c0</span>
<span class="bold">--- /dev/null</span>
<span class="bold">+++ b/ NIM_iOS_Demo_v2.9.0/NIMKit/NIMKit/Classes/Sections/Session/View/SessionContentView/NIMSessionEmojiContentView.m</span>	
<span class="f6">@@ -0,0 +1,105 @@</span>
<span class="f2">//</span>
<span class="f2">//  NIMSessionEmojiContentView.m</span>
<span class="f2">//  NIMKit</span>
<span class="f2">//</span>
<span class="f2">//  Created by isan on 10/10/2016.</span>
<span class="f2">//  Copyright © 2016 NetEase. All rights reserved.</span>
<span class="f2">//</span>

<span class="f2">#import &quot;NIMSessionEmojiContentView.h&quot;</span>
<span class="f2">#import &quot;NIMMessageModel.h&quot;</span>
<span class="f2">#import &quot;UIView+NIM.h&quot;</span>
<span class="f2">#import &quot;NIMLoadProgressView.h&quot;</span>

<span class="f2">//BQMM集成</span>
<span class="f2">#import &lt;BQMM/BQMM.h&gt;</span>

<span class="f2">@interface NIMSessionEmojiContentView()</span>

<span class="f2">@property (nonatomic,strong,readwrite) UIImageView * imageView;</span>

<span class="f2">@property (nonatomic,strong) NIMLoadProgressView * progressView;</span>

<span class="f2">@end</span>

<span class="f2">@implementation NIMSessionEmojiContentView</span>

<span class="f2">- (instancetype)initSessionMessageContentView{</span>
<span class="f2">    self = [super initSessionMessageContentView];</span>
<span class="f2">    if (self) {</span>
<span class="f2">        self.opaque = YES;</span>
<span class="f2">        _imageView  = [[UIImageView alloc] initWithFrame:CGRectZero];</span>
<span class="f2">        _imageView.backgroundColor = [UIColor clearColor];</span>
<span class="f2">        [self addSubview:_imageView];</span>
<span class="f2">        _progressView = [[NIMLoadProgressView alloc] initWithFrame:CGRectMake(0, 0, 44, 44)];</span>
<span class="f2">        _progressView.maxProgress = 1.0f;</span>
<span class="f2">        [self addSubview:_progressView];</span>
<span class="f2">        </span>
<span class="f2">    }</span>
<span class="f2">    return self;</span>
<span class="f2">}</span>

<span class="f2">- (void)refresh:(NIMMessageModel *)data{</span>
<span class="f2">    [super refresh:data];</span>
<span class="f2">    self.bubbleImageView.hidden = YES;</span>
<span class="f2">    //BQMM集成</span>
<span class="f2">    self.imageView.image = [UIImage imageNamed:@&quot;mm_emoji_loading&quot;];</span>
<span class="f2">    NSDictionary *ext = data.message.remoteExt;</span>
<span class="f2">    if ([ext[@&quot;txt_msgType&quot;] isEqualToString:@&quot;facetype&quot;]) {</span>
<span class="f2">    </span>
<span class="f2">        NSArray *codes = nil;</span>
<span class="f2">        if (ext[@&quot;msg_data&quot;]) {</span>
<span class="f2">            codes = @[ext[@&quot;msg_data&quot;][0][0]];</span>
<span class="f2">        }</span>
<span class="f2">        __weak typeof(self) weakself = self;</span>
<span class="f2">        [[MMEmotionCentre defaultCentre] fetchEmojisByType:MMFetchTypeBig codes:codes completionHandler:^(NSArray *emojis) {</span>
<span class="f2">            if (emojis.count &gt; 0) {</span>
<span class="f2">                MMEmoji *emoji = emojis[0];</span>
<span class="f2">                if ([codes[0] isEqualToString:emoji.emojiCode]) {</span>
<span class="f2">                    weakself.imageView.image = emoji.emojiImage; //TODO</span>
<span class="f2">                }</span>
<span class="f2">            }</span>
<span class="f2">            else {</span>
<span class="f2">                weakself.imageView.image = [UIImage imageNamed:@&quot;mm_emoji_error&quot;];</span>
<span class="f2">            }</span>
<span class="f2">        }];</span>
<span class="f2">    }</span>
<span class="f2">    self.progressView.hidden     = self.model.message.isOutgoingMsg ? (self.model.message.deliveryState != NIMMessageDeliveryStateDelivering) : (self.model.message.attachmentDownloadState != NIMMessageAttachmentDownloadStateDownloading);</span>
<span class="f2">    if (!self.progressView.hidden) {</span>
<span class="f2">        [self.progressView setProgress:[[[NIMSDK sharedSDK] chatManager] messageTransportProgress:self.model.message]];</span>
<span class="f2">    }</span>
<span class="f2">}</span>

<span class="f2">- (void)layoutSubviews{</span>
<span class="f2">    [super layoutSubviews];</span>
<span class="f2">    UIEdgeInsets contentInsets = self.model.contentViewInsets;</span>
<span class="f2">    CGSize contentSize = self.model.contentSize;</span>
<span class="f2">    CGRect imageViewFrame = CGRectMake(contentInsets.left, contentInsets.top, contentSize.width, contentSize.height);</span>
<span class="f2">    self.imageView.frame  = imageViewFrame;</span>
<span class="f2">    _progressView.frame   = self.bounds;</span>
<span class="f2">    </span>
<span class="f2">    CALayer *maskLayer = [CALayer layer];</span>
<span class="f2">    maskLayer.cornerRadius = 13.0;</span>
<span class="f2">    maskLayer.backgroundColor = [UIColor blackColor].CGColor;</span>
<span class="f2">    maskLayer.frame = self.imageView.bounds;</span>
<span class="f2">    self.imageView.layer.mask = maskLayer;</span>
<span class="f2">}</span>


<span class="f2">- (void)onTouchUpInside:(id)sender</span>
<span class="f2">{</span>
<span class="f2">    NIMKitEvent *event = [[NIMKitEvent alloc] init];</span>
<span class="f2">    event.eventName = NIMKitEventNameTapContent;</span>
<span class="f2">    event.messageModel = self.model;</span>
<span class="f2">    [self.delegate onCatchEvent:event];</span>
<span class="f2">}</span>

<span class="f2">- (void)updateProgress:(float)progress</span>
<span class="f2">{</span>
<span class="f2">    if (progress &gt; 1.0) {</span>
<span class="f2">        progress = 1.0;</span>
<span class="f2">    }</span>
<span class="f2">    self.progressView.progress = progress;</span>
<span class="f2">}</span>

<span class="f2">@end</span>
<span class="bold">diff --git a/ NIM_iOS_Demo_v2.9.0/NIMKit/NIMKit/Classes/Sections/Session/View/SessionContentView/NIMSessionMessageContentView.m b/ NIM_iOS_Demo_v2.9.0/NIMKit/NIMKit/Classes/Sections/Session/View/SessionContentView/NIMSessionMessageContentView.m</span>
<span class="bold">index 164a8a5..ea1e294 100644</span>
<span class="bold">--- a/ NIM_iOS_Demo_v2.9.0/NIMKit/NIMKit/Classes/Sections/Session/View/SessionContentView/NIMSessionMessageContentView.m</span>	
<span class="bold">+++ b/ NIM_iOS_Demo_v2.9.0/NIMKit/NIMKit/Classes/Sections/Session/View/SessionContentView/NIMSessionMessageContentView.m</span>	
<span class="f6">@@ -33,6 +33,8 @@</span> - (void)refresh:(NIMMessageModel*)data{
    [_bubbleImageView setImage:[self chatBubbleImageForState:UIControlStateNormal outgoing:data.message.isOutgoingMsg]];
    [_bubbleImageView setHighlightedImage:[self chatBubbleImageForState:UIControlStateHighlighted outgoing:data.message.isOutgoingMsg]];
    _bubbleImageView.frame = self.bounds;
    <span class="f2">//BQMM集成</span>
<span class="f2">    _bubbleImageView.hidden = false;</span>
    [self setNeedsLayout];
}

<span class="bold">diff --git a/ NIM_iOS_Demo_v2.9.0/NIMKit/NIMKit/Classes/Sections/Session/View/SessionContentView/NIMSessionTextContentView.h b/ NIM_iOS_Demo_v2.9.0/NIMKit/NIMKit/Classes/Sections/Session/View/SessionContentView/NIMSessionTextContentView.h</span>
<span class="bold">index 9424f02..b249c7d 100644</span>
<span class="bold">--- a/ NIM_iOS_Demo_v2.9.0/NIMKit/NIMKit/Classes/Sections/Session/View/SessionContentView/NIMSessionTextContentView.h</span>	
<span class="bold">+++ b/ NIM_iOS_Demo_v2.9.0/NIMKit/NIMKit/Classes/Sections/Session/View/SessionContentView/NIMSessionTextContentView.h</span>	
<span class="f6">@@ -7,10 +7,13 @@</span>
//

#import &quot;NIMSessionMessageContentView.h&quot;
<span class="f2">//BQMM集成</span>
<span class="f2">#import &quot;MMTextView.h&quot;</span>
@class NIMAttributedLabel;

@interface NIMSessionTextContentView : <span class="f1">NIMSessionMessageContentView</span><span class="f2">NIMSessionMessageContentView&lt;MMTextViewDelegate&gt;</span>

@property (nonatomic, strong) NIMAttributedLabel *textLabel;
<span class="f2">@property (nonatomic, strong) MMTextView *textMessageView;</span>

@end
<span class="bold">diff --git a/ NIM_iOS_Demo_v2.9.0/NIMKit/NIMKit/Classes/Sections/Session/View/SessionContentView/NIMSessionTextContentView.m b/ NIM_iOS_Demo_v2.9.0/NIMKit/NIMKit/Classes/Sections/Session/View/SessionContentView/NIMSessionTextContentView.m</span>
<span class="bold">index ce3dce4..e2e0ade 100644</span>
<span class="bold">--- a/ NIM_iOS_Demo_v2.9.0/NIMKit/NIMKit/Classes/Sections/Session/View/SessionContentView/NIMSessionTextContentView.m</span>	
<span class="bold">+++ b/ NIM_iOS_Demo_v2.9.0/NIMKit/NIMKit/Classes/Sections/Session/View/SessionContentView/NIMSessionTextContentView.m</span>	
<span class="f6">@@ -22,26 +22,48 @@</span> @implementation NIMSessionTextContentView
-(instancetype)initSessionMessageContentView
{
    if (self = [super initSessionMessageContentView]) {
<span class="f2">//</span>        _textLabel = [[NIMAttributedLabel alloc] initWithFrame:CGRectZero];
<span class="f2">//</span>        _textLabel.delegate = self;
<span class="f2">//</span>        _textLabel.numberOfLines = 0;
<span class="f2">//</span>        _textLabel.lineBreakMode = NSLineBreakByWordWrapping;
<span class="f2">//</span>        _textLabel.font = [UIFont systemFontOfSize:NIMKit_Message_Font_Size];
<span class="f2">//</span>        _textLabel.backgroundColor = [UIColor clearColor];
<span class="f2">//</span>        [self addSubview:_textLabel];
        
        <span class="f2">//BQMM集成</span>
<span class="f2">        _textMessageView = [[MMTextView alloc] init];</span>
<span class="f2">        _textMessageView.backgroundColor = [UIColor clearColor];</span>
<span class="f2">        _textMessageView.textContainerInset = UIEdgeInsetsZero;</span>
<span class="f2">        _textMessageView.mmTextColor = [UIColor blackColor];</span>
<span class="f2">        _textMessageView.mmFont = [UIFont systemFontOfSize:NIMKit_Message_Font_Size];</span>
<span class="f2">        _textMessageView.editable = false;</span>
<span class="f2">        _textMessageView.selectable = false;</span>
<span class="f2">        _textMessageView.scrollEnabled = false;</span>
<span class="f2">        _textMessageView.clickActionDelegate = self;</span>
<span class="f2">        [self addSubview:_textMessageView];</span>
    }
    return self;
}

- (void)refresh:(NIMMessageModel *)data{
    [super refresh:data];
    <span class="f2">//BQMM集成</span>
<span class="f2">//</span>    NSString *text = self.model.message.text;
<span class="f2">//</span>    [_textLabel nim_setText:text];
    if (!self.model.message.isOutgoingMsg) {
        <span class="f1">self</span><span class="f2">_textMessageView</span>.<span class="f1">textLabel.textColor</span><span class="f2">mmTextColor</span> = [UIColor blackColor];
    }else{
        <span class="f1">self</span><span class="f2">_textMessageView</span>.<span class="f1">textLabel.textColor</span><span class="f2">mmTextColor</span> = [UIColor whiteColor];
    }
    
    <span class="f2">NSDictionary *extDic = data.message.remoteExt;</span>
<span class="f2">    if(extDic[@&quot;msg_data&quot;] != nil) {</span>
<span class="f2">        [_textMessageView setMmTextData:extDic[@&quot;msg_data&quot;]];</span>
<span class="f2">    }else{</span>
<span class="f2">        _textMessageView.text = data.message.text;</span>
<span class="f2">        [_textMessageView setURLAttributes];</span>
<span class="f2">    }</span>

}

- (void)layoutSubviews{
<span class="f6">@@ -49,7 +71,16 @@</span> - (void)layoutSubviews{
    UIEdgeInsets contentInsets = self.model.contentViewInsets;
    CGSize contentsize         = self.model.contentSize;
    CGRect labelFrame = CGRectMake(contentInsets.left, contentInsets.top, contentsize.width, contentsize.height);
    <span class="f2">//BQMM集成</span>
<span class="f2">//</span>    self.textLabel.frame = labelFrame;
    
    <span class="f2">_textMessageView.frame = labelFrame;</span>
<span class="f2">}</span>

<span class="f2">//BQMM集成</span>
<span class="f2">- (void)onTouchUpInside:(id)sender</span>
<span class="f2">{</span>
<span class="f2">    NSLog(@&quot;点击了文字消息&quot;);</span>
}


<span class="f6">@@ -63,4 +94,28 @@</span> - (void)nimAttributedLabel:(NIMAttributedLabel *)label
    [self.delegate onCatchEvent:event];
}

<span class="f2">//BQMM集成</span>
<span class="f2">#pragma mark MMTextViewDelegate</span>
<span class="f2">- (void)mmTextView:(MMTextView *)textView didSelectLinkWithPhoneNumber:(NSString *)phoneNumber {</span>
<span class="f2">    NSString *number = [@&quot;tel://&quot; stringByAppendingString:phoneNumber];</span>
<span class="f2">    </span>
<span class="f2">    NIMKitEvent *event = [[NIMKitEvent alloc] init];</span>
<span class="f2">    event.eventName = NIMKitEventNameTapLabelLink;</span>
<span class="f2">    event.messageModel = self.model;</span>
<span class="f2">    event.data = number;</span>
<span class="f2">    [self.delegate onCatchEvent:event];</span>
<span class="f2">}</span>

<span class="f2">- (void)mmTextView:(MMTextView *)textView didSelectLinkWithURL:(NSURL *)url {</span>
<span class="f2">    NSString *urlString=[url absoluteString];</span>
<span class="f2">    if (![urlString hasPrefix:@&quot;http&quot;]) {</span>
<span class="f2">        urlString = [@&quot;http://&quot; stringByAppendingString:urlString];</span>
<span class="f2">    }</span>
<span class="f2">    NIMKitEvent *event = [[NIMKitEvent alloc] init];</span>
<span class="f2">    event.eventName = NIMKitEventNameTapLabelLink;</span>
<span class="f2">    event.messageModel = self.model;</span>
<span class="f2">    event.data = urlString;</span>
<span class="f2">    [self.delegate onCatchEvent:event];</span>
<span class="f2">}</span>

@end
</pre>
</body>
</html>
